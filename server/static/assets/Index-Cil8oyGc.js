import{J as e,d as a,k as l,w as t,c as s,a as n,K as r,I as o,L as c,G as i,o as u,_ as d,B as v,D as f,F as p,M as g,N as m,O as y,t as h,C as b,E as k,P as w,r as _}from"./index-B9ZAPPyA.js";import{r as $}from"./requst-SMwGbunC.js";import{u as C}from"./user-CnHw-90H.js";import{H as I,B as P}from"./BackButton-B0ZsEBa6.js";function S(){return $.get("/process/progress")}const U=e("process",{state:()=>({stage:0,label:"",file:null}),getters:{},actions:{selectFile(){this.stage=1},clearSelect(){this.stage=0,this.file=null},startUploading(){this.stage=2,this.label="上传"},successUpload(e){this.file=e,this.stage=3},startProcess(){this.stage=4,this.label="转换"},endProcess(e){this.stage=5,this.file=e}},persist:!0}),x={class:"label"},T=d(a({__name:"ProgressBar",props:["percent","height","label"],setup(e){const a=e,d=l(null);return t((()=>a.percent),(e=>{d.value.style=`width: ${e>100?100:e}%`})),(a,l)=>(u(),s(i,null,[n("div",x,[r(o(e.label)+"进度: ",1),n("span",null,o(e.percent)+"%",1)]),n("div",{class:"bar-box",style:c(`height:${e.height}`)},[n("div",{class:"bar",ref_key:"bar",ref:d},null,512)],4)],64))}}),[["__scopeId","data-v-47cea939"]]);function B(e){const a=Math.floor(e/3600),l=Math.floor(e%3600/60),t=Math.floor(e%60);return a>0?`${a}:${l.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`:l>0?`${l}:${t.toString().padStart(2,"0")}`:`0:${t.toString().padStart(2,"0")}`}const R={class:"container"},j=["src"],F={class:"time"},L={key:0},M={class:"command"},E={class:"large inter"},q=d(a({__name:"AudioPlayer",props:["src"],setup(e){const a=e,r=l(!1),c=l(0),i=l(0),d=l(null);let h=null;t((()=>a.src),(e=>{d.value.src=e,d.value.load()}));const b=()=>{c.value=d.value.duration},k=e=>{if(d.value){const a=e/100*c.value;d.value.currentTime=a}},w=()=>{r.value=!0,d.value.play()},_=()=>{r.value=!1,d.value.pause()},$=()=>{h||(h=window.setInterval((()=>{i.value=d.value.currentTime/c.value*100}),1e3))},C=()=>{i.value=d.value.currentTime/c.value*100,h&&(window.clearInterval(h),h=null)},I=()=>{r.value=!1,d.value.currentTime=0,i.value=0,d.value.pause()};return(a,l)=>{const t=y("a-slider"),h=y("icon-double-left"),P=y("icon-play-arrow-fill"),S=y("icon-pause"),U=y("icon-double-right");return u(),s("div",R,[n("audio",{ref_key:"audioRef",ref:d,src:e.src,onCanplay:b,onPlay:$,onPause:C,onEnded:I},null,40,j),v(t,{"default-value":0,modelValue:i.value,"onUpdate:modelValue":l[0]||(l[0]=e=>i.value=e),onChange:k,"show-tooltip":!1},null,8,["modelValue"]),n("div",F,[d.value?(u(),s("div",L,o(f(B)(d.value.currentTime)),1)):p("",!0),n("div",null,o(f(B)(c.value)),1)]),n("div",M,[n("div",{class:"small inter",onClick:l[1]||(l[1]=e=>(e=>{let a=d.value.currentTime-e;a=a<0?0:a,d.value.currentTime=a,i.value=a/c.value*100})(5))},[v(h,{style:{"stroke-width":"5"}})]),n("div",E,[g(v(P,{style:{"stroke-width":"5"},onClick:w},null,512),[[m,!r.value]]),g(v(S,{style:{"stroke-width":"5"},onClick:_},null,512),[[m,r.value]])]),n("div",{class:"small inter",onClick:l[2]||(l[2]=e=>(e=>{let a=d.value.currentTime+e;a=a>c.value?c.value:a,d.value.currentTime=a,i.value=a/c.value*100})(5))},[v(U,{style:{"stroke-width":"5"}})])])])}}}),[["__scopeId","data-v-bbce3789"]]),V={class:"container"},D={class:"title"},O={class:"btn transparent"},A={class:"content"},G={class:"file-preview flex-center",for:"select"},H={key:2,class:"text mt-1 file-name"},J={key:3,class:"text mt-1 file-name"},K={class:"text mt-1 stage"},N=["disabled"],z={class:"foot-box flex-center"},Q={key:3},W=d(a({__name:"Index",setup(e){const a=U(),t=C(),c=l(null),i=l(0),d=l(""),x=["选择音频","待上传","上传中","已上传","处理中","已处理"],B=e=>{c.value=e.target.files[0],a.selectFile()},R=async()=>{try{let e=new FormData;e.set("audio_file",c.value),e.set("id",t.userId),a.startUploading();const l=await function(e,a){return $.post("/upload/start",e,{headers:{"content-type":"multipart/form-data"},onUploadProgress:a})}(e,(function(e){i.value=Math.round(100*e.loaded/e.total)}));1===l.flag?a.successUpload(l.file):w.error("上传失败")}catch{a.selectFile()}};let j=null;const F=async()=>{a.startProcess(),X();const e=await(l=_.currentRoute.value.query.spk,t=a.file.name,$.get(`/process/start?spk=${l}&name=${t}`));var l,t;e.flag&&(j&&(clearInterval(j),j=null),a.endProcess(e.file),d.value=`${$.defaults.baseURL}/src/${a.file.url}`)},L=async()=>{const e=await(l=a.file.name,$.get(`/process/audio/download/${l}`,{responseType:"blob"}));var l;const t=window.URL.createObjectURL(new Blob([e.data])),s=document.createElement("a");s.style.display="none",s.download=`${a.file.spk}-${a.file.name}`,s.href=t,s.click(),s.remove(),w.success("下载完成了喵")},M=async()=>{try{const{flag:l}=await(e=a.file.name,$.delete(`/upload/audio?name=${e}`));l?a.clearSelect():w.error("删除失败")}catch{w.error("删除失败")}var e},E=async()=>{try{const{flag:l}=await(e=a.file.name,$.delete(`/process/audio?name=${e}`));l?a.successUpload(a.file):w.error("删除失败")}catch{w.error("删除失败")}var e},W=()=>{3===a.stage?M():5===a.stage?E():1===a.stage&&(a.clearSelect(),document.getElementById("select").value="",c.value=null)},X=()=>{j||(j=setInterval((async function(){const e=await S();i.value=e.value}),1e3))};return h((()=>{j&&(clearInterval(j),j=null)})),(async()=>{const e=await $.get("/process/audio");if(e.flag)a.endProcess(e.file),d.value=`${$.defaults.baseURL}/src${a.file.url}`;else{const e=await $.get("/upload/audio");if(e.flag){const l=await S();l.flag?l.value<100&&(a.startProcess(),X()):a.successUpload(e.file)}else a.clearSelect()}})(),(e,l)=>{const t=y("icon-more-vertical"),h=y("icon-delete"),w=y("a-doption"),$=y("icon-download"),C=y("a-dropdown"),S=y("icon-folder-add"),U=y("icon-file-audio");return u(),s("div",V,[v(I,null,{left:b((()=>[v(P)])),middle:b((()=>[n("span",D,"转换器-"+o(f(_).currentRoute.value.query.spk),1)])),right:b((()=>[v(C,{position:"br"},{content:b((()=>[g(v(w,{onClick:W},{icon:b((()=>[v(h,{style:{"stroke-width":"5"}})])),default:b((()=>[r("删除")])),_:1},512),[[m,c.value||3===f(a).stage||5===f(a).stage]]),g(v(w,{onClick:L},{icon:b((()=>[v($,{style:{"stroke-width":"5"}})])),default:b((()=>[r("下载")])),_:1},512),[[m,5===f(a).stage]])])),default:b((()=>[g(n("button",O,[v(t)],512),[[m,1===f(a).stage||3===f(a).stage||5===f(a).stage]])])),_:1})])),_:1}),n("div",A,[n("label",G,[n("div",null,[0===f(a).stage?(u(),k(S,{key:0,class:"icon"})):(u(),k(U,{key:1,class:"icon"})),f(a).stage>=3?(u(),s("div",H,o(f(a).file.name),1)):p("",!0),c.value&&f(a).stage<3?(u(),s("div",J,o(c.value.name),1)):p("",!0),n("div",K,o(x[f(a).stage]),1)])]),n("input",{id:"select",type:"file",accept:".wav, .mp3, .flac",onChange:B,style:{display:"none"},disabled:0!==f(a).stage},null,40,N)]),n("div",z,[1===f(a).stage?(u(),s("button",{key:0,class:"btn normal long mb-1",onClick:R},"上传")):p("",!0),2===f(a).stage||4===f(a).stage?(u(),k(T,{key:1,class:"progress",height:"0.3rem",label:f(a).label,percent:i.value},null,8,["label","percent"])):p("",!0),3===f(a).stage?(u(),s("button",{key:2,class:"btn normal long mb-1",onClick:F},"开始转换")):p("",!0),5===f(a).stage?(u(),s("h3",Q,o(f(a).file.spk),1)):p("",!0),5===f(a).stage?(u(),k(q,{key:4,src:d.value},null,8,["src"])):p("",!0)])])}}}),[["__scopeId","data-v-cfff0a65"]]);export{W as default};
