import{J as e,s as a,r as l,w as t,t as s,y as n,K as r,G as o,L as c,F as i,D as u,_ as d,v,z as p,B as f,M as g,N as m,O as y,h,x as b,A as k,P as w,C as _}from"./index-DDxW1fSN.js";import{r as $}from"./requst-D7HpWZZY.js";import{u as C}from"./user-CohLtc4d.js";import{H as P,B as S}from"./BackButton-D9M2QRD5.js";function U(){return $.get("/process/progress")}const x=e("process",{state:()=>({stage:0,label:"",file:null}),getters:{},actions:{selectFile(){this.stage=1},clearSelect(){this.stage=0,this.file=null},startUploading(){this.stage=2,this.label="上传"},successUpload(e){this.file=e,this.stage=3},startProcess(){this.stage=4,this.label="转换"},endProcess(e){this.stage=5,this.file=e}},persist:!0}),I={class:"label"},T=d(a({__name:"ProgressBar",props:["percent","height","label"],setup(e){const a=e,d=l(null);return t((()=>a.percent),(e=>{d.value.style=`width: ${e>100?100:e}%`})),(a,l)=>(u(),s(i,null,[n("div",I,[r(o(e.label)+"进度: ",1),n("span",null,o(e.percent)+"%",1)]),n("div",{class:"bar-box",style:c(`height:${e.height}`)},[n("div",{class:"bar",ref_key:"bar",ref:d},null,512)],4)],64))}}),[["__scopeId","data-v-47cea939"]]);function B(e){const a=Math.floor(e/3600),l=Math.floor(e%3600/60),t=Math.floor(e%60);return a>0?`${a}:${l.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`:l>0?`${l}:${t.toString().padStart(2,"0")}`:`0:${t.toString().padStart(2,"0")}`}const R={class:"container"},j=["src"],F={class:"time"},L={key:0},M={class:"command"},q={class:"large inter"},E=d(a({__name:"AudioPlayer",props:["src"],setup(e){const a=e,r=l(!1),c=l(0),i=l(0),d=l(null);let h=null;t((()=>a.src),(e=>{d.value.src=e,d.value.load()}));const b=()=>{c.value=d.value.duration},k=e=>{if(d.value){const a=e/100*c.value;d.value.currentTime=a}},w=()=>{r.value=!0,d.value.play()},_=()=>{r.value=!1,d.value.pause()},$=()=>{h||(h=window.setInterval((()=>{i.value=d.value.currentTime/c.value*100}),1e3))},C=()=>{i.value=d.value.currentTime/c.value*100,h&&(window.clearInterval(h),h=null)},P=()=>{r.value=!1,d.value.currentTime=0,i.value=0,d.value.pause()};return(a,l)=>{const t=y("a-slider"),h=y("icon-double-left"),S=y("icon-play-arrow-fill"),U=y("icon-pause"),x=y("icon-double-right");return u(),s("div",R,[n("audio",{ref_key:"audioRef",ref:d,src:e.src,onCanplay:b,onPlay:$,onPause:C,onEnded:P},null,40,j),v(t,{"default-value":0,modelValue:i.value,"onUpdate:modelValue":l[0]||(l[0]=e=>i.value=e),onChange:k,"show-tooltip":!1},null,8,["modelValue"]),n("div",F,[d.value?(u(),s("div",L,o(p(B)(d.value.currentTime)),1)):f("",!0),n("div",null,o(p(B)(c.value)),1)]),n("div",M,[n("div",{class:"small inter",onClick:l[1]||(l[1]=e=>(e=>{let a=d.value.currentTime-e;a=a<0?0:a,d.value.currentTime=a,i.value=a/c.value*100})(5))},[v(h,{style:{"stroke-width":"5"}})]),n("div",q,[g(v(S,{style:{"stroke-width":"5"},onClick:w},null,512),[[m,!r.value]]),g(v(U,{style:{"stroke-width":"5"},onClick:_},null,512),[[m,r.value]])]),n("div",{class:"small inter",onClick:l[2]||(l[2]=e=>(e=>{let a=d.value.currentTime+e;a=a>c.value?c.value:a,d.value.currentTime=a,i.value=a/c.value*100})(5))},[v(x,{style:{"stroke-width":"5"}})])])])}}}),[["__scopeId","data-v-bbce3789"]]),V={class:"container"},A={class:"title"},D={class:"btn transparent"},O={class:"content"},z={class:"file-preview flex-center",for:"select"},G={key:2,class:"text mt-1 file-name"},H={key:3,class:"text mt-1 file-name"},J={class:"text mt-1 stage"},K=["disabled"],N={class:"foot-box flex-center"},Q={key:3},W=d(a({__name:"Index",setup(e){const a=x(),t=C(),c=l(null),i=l(0),d=l(""),I=["选择音频","待上传","上传中","已上传","处理中","已处理"],B=e=>{c.value=e.target.files[0],a.selectFile()},R=async()=>{try{let e=new FormData;e.set("audio_file",c.value),e.set("id",t.userId),a.startUploading();const l=await function(e,a){return $.post("/upload/start",e,{headers:{"content-type":"multipart/form-data"},onUploadProgress:a})}(e,(function(e){i.value=Math.round(100*e.loaded/e.total)}));1===l.flag?a.successUpload(l.file):w.error("上传失败")}catch{a.selectFile()}};let j=null;const F=async()=>{a.startProcess(),X();const e=await(l=_.currentRoute.value.query.spk,t=a.file.name,$.get(`/process/start?spk=${l}&name=${t}`));var l,t;e.flag&&(j&&(clearInterval(j),j=null),a.endProcess(e.file),d.value=`${$.defaults.baseURL}/src/${a.file.url}`)},L=async()=>{const e=await(l=a.file.name,$.get(`/process/audio/download/${l}`,{responseType:"blob"}));var l;const t=window.URL.createObjectURL(new Blob([e],{type:"audio/*"})),s=document.createElement("a");s.style.display="none",s.download=`${a.file.spk}-${a.file.name}`,s.href=t,s.click(),s.remove(),w.success("下载完成了喵")},M=async()=>{try{const{flag:l}=await(e=a.file.name,$.delete(`/upload/audio?name=${e}`));l?a.clearSelect():w.error("删除失败")}catch{w.error("删除失败")}var e},q=async()=>{try{const{flag:l}=await(e=a.file.name,$.delete(`/process/audio?name=${e}`));l?a.successUpload(a.file):w.error("删除失败")}catch{w.error("删除失败")}var e},W=()=>{3===a.stage?M():5===a.stage?q():1===a.stage&&(a.clearSelect(),document.getElementById("select").value="",c.value=null)},X=()=>{j||(j=setInterval((async function(){const e=await U();i.value=e.value}),1e3))};return h((()=>{j&&(clearInterval(j),j=null)})),(async()=>{const e=await $.get("/process/audio");if(e.flag)a.endProcess(e.file),d.value=`${$.defaults.baseURL}/src${a.file.url}`;else{const e=await $.get("/upload/audio");if(e.flag){const l=await U();l.flag?l.value<100&&(a.startProcess(),X()):a.successUpload(e.file)}else a.clearSelect()}})(),(e,l)=>{const t=y("icon-more-vertical"),h=y("icon-delete"),w=y("a-doption"),$=y("icon-download"),C=y("a-dropdown"),U=y("icon-folder-add"),x=y("icon-file-audio");return u(),s("div",V,[v(P,null,{left:b((()=>[v(S)])),middle:b((()=>[n("span",A,"转换器-"+o(p(_).currentRoute.value.query.spk),1)])),right:b((()=>[v(C,{position:"br"},{content:b((()=>[g(v(w,{onClick:W},{icon:b((()=>[v(h,{style:{"stroke-width":"5"}})])),default:b((()=>[r("删除")])),_:1},512),[[m,c.value||3===p(a).stage||5===p(a).stage]]),g(v(w,{onClick:L},{icon:b((()=>[v($,{style:{"stroke-width":"5"}})])),default:b((()=>[r("下载")])),_:1},512),[[m,5===p(a).stage]])])),default:b((()=>[g(n("button",D,[v(t)],512),[[m,1===p(a).stage||3===p(a).stage||5===p(a).stage]])])),_:1})])),_:1}),n("div",O,[n("label",z,[n("div",null,[0===p(a).stage?(u(),k(U,{key:0,class:"icon"})):(u(),k(x,{key:1,class:"icon"})),p(a).stage>=3?(u(),s("div",G,o(p(a).file.name),1)):f("",!0),c.value&&1===p(a).stage?(u(),s("div",H,o(c.value.name),1)):f("",!0),n("div",J,o(I[p(a).stage]),1)])]),n("input",{id:"select",type:"file",accept:"audio/*",onChange:B,style:{display:"none"},disabled:0!==p(a).stage},null,40,K)]),n("div",N,[1===p(a).stage?(u(),s("button",{key:0,class:"btn normal long mb-1",onClick:R},"上传")):f("",!0),2===p(a).stage||4===p(a).stage?(u(),k(T,{key:1,class:"progress",height:"0.3rem",label:p(a).label,percent:i.value},null,8,["label","percent"])):f("",!0),3===p(a).stage?(u(),s("button",{key:2,class:"btn normal long mb-1",onClick:F},"开始转换")):f("",!0),5===p(a).stage?(u(),s("h3",Q,o(p(a).file.spk),1)):f("",!0),5===p(a).stage?(u(),k(E,{key:4,src:d.value},null,8,["src"])):f("",!0)])])}}}),[["__scopeId","data-v-c0a0b8f7"]]);export{W as default};
